<!DOCTYPE html>
<html lang="en">

<head>
  <!-- 
        HELLO!

        Head over to github for a hack:
            https://github.com/benfoxall/giflist 
    -->
  <meta charset="utf-8" />
  <title>GifList</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://media.giphy.com" />
  <meta charset="utf-8" />
  <style>
    body {
      font-family: sans-serif;
      background: #eee;
    }

    ul {
      display: flex;
      flex-wrap: wrap;
      list-style: none;
      padding: 0;

      max-width: 50em;
      margin: auto;
    }

    li {
      height: 8em;
      flex-grow: 0;
      margin: 0.5em
    }

    img {
      border: 1px solid;
      max-height: 100%;
      min-width: 100%;
      object-fit: contain;
      vertical-align: bottom;
      background: #fff;
      transition: opacity .1s, transform .3s;
      opacity: 1;
    }

    img.init {
      opacity: 0;
      transform: scale(0.7);
    }

    img.sized {
      transform: scale(0.8);
    }

    img.placehold {
      transform: scale(1);
      cursor: pointer;
    }

    img.loading {
      transform: scale(0.8);
      filter: blur(5px);
    }

    img.loaded {
      transform: scale(1);
    }
  </style>
</head>

<body>
  <h1>giflist</h1>
  <ul id="giflist"></ul>
  <script type="module">
    const gifs = [
      "https://media.giphy.com/media/3ornjZLITGcFQVRbxK/source.gif",
      "https://media.giphy.com/media/3NwahoGmAzVsyyGgaV/source.gif",
      "https://media.giphy.com/media/vwF2MCJiQk1kKgnS7l/source.gif",
      "https://media.giphy.com/media/BLxPyPNcfRXIUPxh6Q/source.gif",
      "https://media.giphy.com/media/fSYmbgG5Ug8S11K0FU/source.gif",
      "https://media.giphy.com/media/McgWV3RzDQZZNdFWRA/source.gif",
      "https://media.giphy.com/media/drUQaRAxnTL4Q/giphy.gif",
      "https://media.giphy.com/media/KPtSLVJfug7DO/giphy.gif",
      "https://media.giphy.com/media/TFTWZWphtZAsWzJyx9/source.gif",
      "https://media.giphy.com/media/3o7TKwdgwM1ZQMISu4/source.gif",
      "https://media.giphy.com/media/l41lMMzTCBvXqtEUU/source.gif",
      "https://media.giphy.com/media/STLj8QUhg25pe/source.gif",
      "https://media.giphy.com/media/JkF5aGMSrtG5q/source.gif",
      "https://media.giphy.com/media/raBbE1fizfZGE/source.gif",
      "https://media.giphy.com/media/30pNidV6fJHivbPsaR/source.gif",
      "https://media.giphy.com/media/XdPgs5ROUjIJxVzHx0/giphy.gif",
      "https://media.giphy.com/media/3otPoKr6JOyejCyJAA/giphy.gif",
      "https://media.giphy.com/media/3otPoHMzdMgfZznjpe/giphy.gif",
      "https://media.giphy.com/media/KGeKS2bN3Vy0ALQ1Rf/giphy.gif",
      "https://media.giphy.com/media/l0ErUoYi9bFdZJ3mo/giphy.gif",
      "https://media.giphy.com/media/7yQgwmG4jmDOl0QrRa/giphy.gif",
      "https://media.giphy.com/media/KzzMbCNB0fLtCbwq5h/giphy.gif",
      "https://media.giphy.com/media/kbv4CXxXR65UivX8qT/giphy.gif",
      "https://media.giphy.com/media/xUA7bcTVvYq5oZUvSw/giphy.gif",
      "https://media.giphy.com/media/TvVck7lO4LDJS/giphy-downsized-large.gif",
      "https://media.giphy.com/media/Y1GK5MEiRa3OSVsxHK/giphy.gif",
      "https://media.giphy.com/media/tWTgJV6bZQLLi/giphy.gif",
      "https://media.giphy.com/media/xUPGcDzMVxsPAiV1Ti/giphy.gif",
      "https://media.giphy.com/media/LV979NzyOBjKBwK9gD/giphy.gif",
      "https://media.giphy.com/media/xT9IgEk8W4Vu7cixhe/giphy.gif",
      "https://media.giphy.com/media/iIuowhW7k2diw/giphy.gif",
      "https://media.giphy.com/media/3o6vY2wgzLY2K1MKB2/giphy.gif",
      "https://media.giphy.com/media/11nBTBqgQRpe36/giphy.gif",
    ];


    let i = 0;
    for (const url of gifs) {
      const li = document.createElement("li");
      giflist.appendChild(li);

      const img = document.createElement("img");
      img.src = svgSrc();
      li.appendChild(img);

      img.className = 'init'

      let complete = false;

      img.addEventListener(
        "click",
        () => {
          complete = true;
          img.className = 'loading'
          img.src = url;
          img.addEventListener('load', () => {
            img.className = 'loaded'
          })
        },
        {
          once: true,
        }
      );



      gifsize(url).then((res) => {
        if (!complete) {
          img.className = 'sized'
          img.src = svgSrc(res.width, res.height)
        }
      });

      const limit = i++ < 50;
      if (limit) {
        gifframe(url).then((res) => {
          if (!complete) {
            complete = true;
            img.src = res;
            img.className = 'placehold'
          }
        });
      }

    }

    // return a svg image of given dimensions
    function svgSrc(width = 300, height = 300) {
      return `data:image/svg+xml,%3Csvg width='${width}' height='${height}' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='${width / 2}' cy='${height / 2}' r='15' fill='%23eee' /%3E%3C/svg%3E`;
    }

    // fetch the dimensions of the gif
    async function gifsize(url) {
      const result = await fetch(url, { headers: { Range: "bytes=6-9" } });

      const [width, height] = new Uint16Array(await result.arrayBuffer());

      return { width, height };
    }

    // Fetch the first frame of the gif
    async function gifframe(url) {

      const worker = new Worker('./omggif-worker.js');
      worker.postMessage(url)
      const imageData = await new Promise(resolve => {
        worker.addEventListener('message', (e) => resolve(e.data))
      })
      worker.terminate()

      var canvas = document.createElement('canvas');
      var ctx = canvas.getContext('2d');
      canvas.width = imageData.width
      canvas.height = imageData.height
      ctx.putImageData(imageData, 0, 0);


      return canvas.toDataURL();
    }


  </script>
</body>

</html>
