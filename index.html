<!DOCTYPE html>
<html lang="en">

<head>
  <!-- 
        HELLO!

        Head over to github for a hack:
            https://github.com/benfoxall/giflist 
    -->
  <meta charset="utf-8" />
  <title>GifList</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://media.giphy.com" />
  <meta charset="utf-8" />
  <style>
    body {
      font-family: sans-serif;
      background: #eee;
    }

    ul {
      display: flex;
      flex-wrap: wrap;
      list-style: none;
      padding: 0;

      max-width: 50em;
      margin: auto;
    }

    li {
      height: 8em;
      flex-grow: 0;
      margin: 0.5em
    }

    img {
      border: 1px solid;
      max-height: 100%;
      min-width: 100%;
      object-fit: contain;
      vertical-align: bottom;
      background: #fff;
      transition: opacity .1s, transform .3s;
      opacity: 1;
    }

    img.init {
      opacity: 0.2;
      transform: scale(0.7);
    }

    img.sized {
      transform: scale(0.8);
    }

    img.placehold {
      transform: scale(1);
    }

    img.loading {
      transform: scale(0.8);
      filter: blur(5px);
    }

    img.loaded {
      transform: scale(1);
    }
  </style>
</head>

<body>
  <h1>giflist</h1>
  <form>
    <label>
      <input type="checkbox" name="layout">
      layout
    </label>
    <label>
      <input type="checkbox" name="first">
      first frame
    </label>
    <label>
      <input type="checkbox" name="full">
      full gif
    </label>
    <button>load</button>

    <script>
      // persist checkboxes
      const params = new URLSearchParams(document.location.search);
      for (const input of document.querySelectorAll('input')) {
        input.checked = params.has(input.name)
      }
    </script>
  </form>
  <ul id="giflist">
    <li><img class="init" data-src="https://media.giphy.com/media/3ornjZLITGcFQVRbxK/source.gif" /></li>
    <li><img class="init" data-src="https://media.giphy.com/media/3NwahoGmAzVsyyGgaV/source.gif" /></li>
    <li><img class="init" data-src="https://media.giphy.com/media/vwF2MCJiQk1kKgnS7l/source.gif" /></li>
    <li><img class="init" data-src="https://media.giphy.com/media/BLxPyPNcfRXIUPxh6Q/source.gif" /></li>
    <li><img class="init" data-src="https://media.giphy.com/media/fSYmbgG5Ug8S11K0FU/source.gif" /></li>
    <li><img class="init" data-src="https://media.giphy.com/media/McgWV3RzDQZZNdFWRA/source.gif" /></li>
    <li><img class="init" data-src="https://media.giphy.com/media/drUQaRAxnTL4Q/giphy.gif" /></li>
    <li><img class="init" data-src="https://media.giphy.com/media/KPtSLVJfug7DO/giphy.gif" /></li>
    <li><img class="init" data-src="https://media.giphy.com/media/TFTWZWphtZAsWzJyx9/source.gif" /></li>
    <li><img class="init" data-src="https://media.giphy.com/media/3o7TKwdgwM1ZQMISu4/source.gif" /></li>
    <li><img class="init" data-src="https://media.giphy.com/media/l41lMMzTCBvXqtEUU/source.gif" /></li>
    <li><img class="init" data-src="https://media.giphy.com/media/STLj8QUhg25pe/source.gif" /></li>
    <li><img class="init" data-src="https://media.giphy.com/media/JkF5aGMSrtG5q/source.gif" /></li>
    <li><img class="init" data-src="https://media.giphy.com/media/raBbE1fizfZGE/source.gif" /></li>
    <li><img class="init" data-src="https://media.giphy.com/media/30pNidV6fJHivbPsaR/source.gif" /></li>
    <li><img class="init" data-src="https://media.giphy.com/media/XdPgs5ROUjIJxVzHx0/giphy.gif" /></li>
    <li><img class="init" data-src="https://media.giphy.com/media/3otPoKr6JOyejCyJAA/giphy.gif" /></li>
    <li><img class="init" data-src="https://media.giphy.com/media/3otPoHMzdMgfZznjpe/giphy.gif" /></li>
    <li><img class="init" data-src="https://media.giphy.com/media/KGeKS2bN3Vy0ALQ1Rf/giphy.gif" /></li>
    <li><img class="init" data-src="https://media.giphy.com/media/l0ErUoYi9bFdZJ3mo/giphy.gif" /></li>
    <li><img class="init" data-src="https://media.giphy.com/media/7yQgwmG4jmDOl0QrRa/giphy.gif" /></li>
    <li><img class="init" data-src="https://media.giphy.com/media/KzzMbCNB0fLtCbwq5h/giphy.gif" /></li>
    <li><img class="init" data-src="https://media.giphy.com/media/kbv4CXxXR65UivX8qT/giphy.gif" /></li>
    <li><img class="init" data-src="https://media.giphy.com/media/xUA7bcTVvYq5oZUvSw/giphy.gif" /></li>
    <li><img class="init" data-src="https://media.giphy.com/media/TvVck7lO4LDJS/giphy-downsized-large.gif" /></li>
    <li><img class="init" data-src="https://media.giphy.com/media/Y1GK5MEiRa3OSVsxHK/giphy.gif" /></li>
    <li><img class="init" data-src="https://media.giphy.com/media/tWTgJV6bZQLLi/giphy.gif" /></li>
    <li><img class="init" data-src="https://media.giphy.com/media/xUPGcDzMVxsPAiV1Ti/giphy.gif" /></li>
    <li><img class="init" data-src="https://media.giphy.com/media/LV979NzyOBjKBwK9gD/giphy.gif" /></li>
    <li><img class="init" data-src="https://media.giphy.com/media/xT9IgEk8W4Vu7cixhe/giphy.gif" /></li>
    <li><img class="init" data-src="https://media.giphy.com/media/iIuowhW7k2diw/giphy.gif" /></li>
    <li><img class="init" data-src="https://media.giphy.com/media/3o6vY2wgzLY2K1MKB2/giphy.gif" /></li>
    <li><img class="init" data-src="https://media.giphy.com/media/11nBTBqgQRpe36/giphy.gif" /></li>
  </ul>
  <script type="module">

    const images = document.querySelectorAll('img');

    for (const img of images) {
      img.src = svgSrc();

      let load = Promise.resolve();

      if (params.has('layout')) {
        load = load
          .then(() => gifsize(img.dataset.src))
          .then(res => {
            img.src = svgSrc(res.width, res.height)
            img.className = 'sized'
          })
      }

      if (params.has('first')) {
        load = load
          .then(() => gifframe(img.dataset.src))
          .then(res => {
            img.src = res;
            img.className = 'placehold'
          })
      }

      if (params.has('full')) {
        load = load
          .then(() => {

            img.className = 'loading'

            const preload = new Image();
            preload.src = img.dataset.src;
            return preload.decode().then(() => preload)
          })
          .then((preload) => {
            const li = img.parentElement;
            li.appendChild(preload)
            li.removeChild(img)
          })

      }
    }



    // return a svg image of given dimensions
    function svgSrc(width = 300, height = 300) {
      return `data:image/svg+xml,%3Csvg width='${width}' height='${height}' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='${width / 2}' cy='${height / 2}' r='15' fill='%23eee' /%3E%3C/svg%3E`;
    }

    // fetch the dimensions of the gif
    async function gifsize(url) {
      const result = await fetch(url, { headers: { Range: "bytes=6-9" } });

      const [width, height] = new Uint16Array(await result.arrayBuffer());

      return { width, height };
    }

    // Fetch the first frame of the gif
    async function gifframe(url) {

      const worker = new Worker('./omggif-worker.js');
      worker.postMessage(url)
      const imageData = await new Promise(resolve => {
        worker.addEventListener('message', (e) => resolve(e.data))
      })
      worker.terminate()

      var canvas = document.createElement('canvas');
      var ctx = canvas.getContext('2d');
      canvas.width = imageData.width
      canvas.height = imageData.height
      ctx.putImageData(imageData, 0, 0);


      return canvas.toDataURL();
    }


  </script>
</body>

</html>
